#!groovy
/*
 * Copyright 2021 by Swiss Post, Information Technology Services
*
*/

@Library('pipeline-library@master') _

def BUILD_INFO = Artifactory.newBuildInfo()
def PROJECT_NAME = 'crypto-primitives'
def SCM_URL_ANON = "https://gitit.post.ch/scm/evoting-anonymized/crypto-primitives.git"

pipeline {

	agent {
		label 'apps-slaves-evoting'
	}

	options {
		disableConcurrentBuilds()
		buildDiscarder(logRotator(numToKeepStr: '10'))
		ansiColor('xterm')
		timestamps()
	}

	stages {

		stage('Prepare') {
			steps {
				step([$class: 'StashNotifier'])
				cleanWs()
				checkout scm
			}
		}

		stage('Anonymize') {
			steps {
				anonymization(
						gitAnonymousUserName: "SwissPost-Bot",
						gitAnonymousUserEmail: "evotingspoc@poste.ch",
						fileToRemove: "Jenkinsfile,JenkinsfileRelease,JenkinsfileAnonymizeDevelop,JenkinsfileFortify,jenkins-release-crypto-primitives.groovy");
			}
		}

		stage('push target branch') {
			steps {
				forcePushWithCredentialsInUrl(
						branch: 'pre-publication-develop',
						url: SCM_URL_ANON,
						credentialsId: "s-cicd-evoting");
			}
		}

	}

	post {
		always {
			step([$class: 'StashNotifier'])
		}
		failure {
			sendBuildMail(projectName: PROJECT_NAME, message: 'Hi, the crypto-primitives develop anonymization build has failed', onError: true, toCommitters: true)
		}
	}
}